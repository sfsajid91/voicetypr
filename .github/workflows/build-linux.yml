name: Build Linux

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ===========================================
  # Build Linux (x86_64 - AppImage + RPM for Fedora)
  # ===========================================
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.13.1

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            rpm \
            libssl-dev \
            pkg-config \
            libxdo-dev \
            libxtst-dev \
            libx11-dev \
            xdotool

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Ensure FFmpeg sidecar
        run: pnpm run sidecar:ensure-ffmpeg

      - name: Build Tauri app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
        run: pnpm tauri build --target x86_64-unknown-linux-gnu --bundles appimage,rpm --config src-tauri/tauri.linux.conf.json --ci --verbose

      - name: Stage artifacts for upload
        run: |
          VERSION=$(node -p "require('./package.json').version")
          mkdir -p artifacts
          find src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/appimage -name "*.AppImage" ! -name "*.sig" -exec cp {} artifacts/ \;
          RPM=$(find src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/rpm -name "*.rpm" | head -1)
          if [ -n "$RPM" ]; then
            cp "$RPM" "artifacts/VoiceTypr_${VERSION}_x86_64.rpm"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64
          path: artifacts/
          retention-days: 5
